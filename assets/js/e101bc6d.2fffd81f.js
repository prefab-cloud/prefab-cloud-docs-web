"use strict";(self.webpackChunkprefab_cloud_docs_web=self.webpackChunkprefab_cloud_docs_web||[]).push([[303],{4010:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>u,frontMatter:()=>t,metadata:()=>l,toc:()=>s});var o=i(4848),a=i(8453);const t={title:"Bootstrapping",sidebar_label:"Bootstrapping",sidebar_position:4},r=void 0,l={id:"explanations/architecture/bootstrapping",title:"Bootstrapping",description:"Config Load Order",source:"@site/docs/explanations/architecture/bootstrapping.md",sourceDirName:"explanations/architecture",slug:"/explanations/architecture/bootstrapping",permalink:"/docs/explanations/architecture/bootstrapping",draft:!1,unlisted:!1,editUrl:"https://github.com/prefab-cloud/prefab-cloud-docs-web/tree/main/docs/explanations/architecture/bootstrapping.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Bootstrapping",sidebar_label:"Bootstrapping",sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Reliability",permalink:"/docs/explanations/architecture/resiliency"},next:{title:"How Tos",permalink:"/docs/category/how-tos"}},c={},s=[{value:"Config Load Order",id:"config-load-order",level:2},{value:"Reconfiguring Config File Locations",id:"reconfiguring-config-file-locations",level:3},{value:"Override Files &amp; Load Order",id:"override-files--load-order",level:2},{value:"Helpful Logging",id:"helpful-logging",level:2},{value:"On Initialization Failure",id:"on-initialization-failure",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.R)(),...e.components},{TabItem:i,Tabs:t}=n;return i||f("TabItem",!0),t||f("Tabs",!0),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h2,{id:"config-load-order",children:"Config Load Order"}),"\n",(0,o.jsxs)(n.admonition,{type:"info",children:[(0,o.jsx)(n.p,{children:"We're replacing the default system with a new pattern that we believe is a much simpler,\nwhile providing even more flexibility, power and resiliency."}),(0,o.jsxs)(n.p,{children:["The core use case of defaults was to provide settings for offline development in testing and CI.\nThis is better solved with our ",(0,o.jsx)(n.a,{href:"/docs/explanations/concepts/testing",children:"datafiles"}),"."]}),(0,o.jsx)(n.p,{children:"If you believe you need this old system, please reach out to us to discuss."})]}),"\n",(0,o.jsx)(n.p,{children:"On startup, config clients load config in the following order, with each level taking precedence over the previous:"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Default ",(0,o.jsx)(n.a,{href:"/docs/explanations/concepts/defaults",children:"Config File"})," ",(0,o.jsx)(n.code,{children:".prefab.default.config.yaml"})," on the classpath"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.a,{href:"/docs/explanations/concepts/defaults#prefab-environments",children:"Prefab Env"})," config files such as ",(0,o.jsx)(n.code,{children:".prefab.staging.config.yaml"}),", ",(0,o.jsx)(n.code,{children:".prefab.test.config.yaml"})," or ",(0,o.jsx)(n.code,{children:".prefab.k8s.config.yaml"})]}),"\n",(0,o.jsxs)(n.li,{children:["Most current values from PrefabCloud APIs & CDNs as described in ",(0,o.jsx)(n.a,{href:"/docs/explanations/concepts/backend-sdks",children:"how the backend SDK works"})]}),"\n",(0,o.jsxs)(n.li,{children:["Local Override File ",(0,o.jsx)(n.code,{children:".prefab.default.config.yaml"})," in the override directory (defaults to $HOME)"]}),"\n",(0,o.jsxs)(n.li,{children:["Local Override Prefab Env Files ",(0,o.jsx)(n.code,{children:".prefab.test.config.yaml"})," in the override directory (defaults to $HOME)"]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"reconfiguring-config-file-locations",children:"Reconfiguring Config File Locations"}),"\n",(0,o.jsxs)(n.p,{children:["The classpath config file location can be changed with the env var ",(0,o.jsx)(n.code,{children:"PREFAB_CONFIG_CLASSPATH_DIR"})]}),"\n",(0,o.jsxs)(n.p,{children:["The local override config file location can be changed with env var ",(0,o.jsx)(n.code,{children:"PREFAB_CONFIG_OVERRIDE_DIR"})]}),"\n",(0,o.jsx)(n.h2,{id:"override-files--load-order",children:"Override Files & Load Order"}),"\n",(0,o.jsx)(n.p,{children:"All API values will take precedence over the values that come from your default files."}),"\n",(0,o.jsxs)(n.p,{children:["For local development, in can be helpful to have your own settings that are not checked into source control. This is the time for an\noverride file. Name your file ",(0,o.jsx)(n.code,{children:".prefab.default.config.yaml"})," and put it in your home directory. These values will have a higher precedence\nthan values from the API."]}),"\n",(0,o.jsx)(n.admonition,{type:"note",children:(0,o.jsxs)(n.p,{children:["Using an Override file in a deployed environment is an anti-pattern. You should be able to achieve what you need to do\nwith some combination of ",(0,o.jsx)(n.a,{href:"/docs/explanations/concepts/defaults#prefab-environments",children:"Prefab Envs"})," and ",(0,o.jsx)(n.a,{href:"/docs/explanations/concepts/context",children:"context"}),"."]})}),"\n",(0,o.jsx)(n.h2,{id:"helpful-logging",children:"Helpful Logging"}),"\n",(0,o.jsxs)(n.p,{children:["Understanding which config your app is using can take some getting used to. To help Prefab has quite a lot of logging.\nYou can turn it all on with ",(0,o.jsx)(n.code,{children:"log-level.cloud.prefab: debug"})," in your ",(0,o.jsx)(n.code,{children:".prefab.default.config.yaml"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"Here you can see the: key, value, type, match and source for each config value.\nThe source tells us whether we are using a value from a config file or an API value.\nThe match tells us whether there is a value defined for the environment or namespace we are using."}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-bash",children:"DEBUG 2022-09-06 09:23:53 -0400: prefab:  Initialize ConfigClient\nINFO  2022-09-06 09:23:53 -0400: prefab:  Load ./.prefab.default.config.yaml\nINFO  2022-09-06 09:23:53 -0400: prefab:  Load /Users/user/.prefab.default.config.yaml\nDEBUG 2022-09-06 09:23:53 -0400: prefab:  Initialize ConfigClient: AcquiredWriteLock\nINFO  2022-09-06 09:23:55 -0400: prefab:  Found new checkpoint with highwater id 16621306673926944 from remote_cdn_api in project X environment: Y and namespace: 'myapp.web'\nINFO  2022-09-06 09:23:55 -0400: prefab:  Unlocked Config via remote_cdn_api\nINFO  2022-09-06 09:23:55 -0400: prefab:\naccounting.api-uage.error-on-unknown-project       | false                               | FalseCl | Match: default                 | Source: ./.prefab.default.config.yaml\nfeatures.api-usage                                 | <Prefab::FeatureFlag: active: true, | Prefab: | Match: env:Y                   | Source: remote_cdn_api\ngoogle.gcp.big-query.dataset_name                  | development_dataset                 | String  | Match: default                 | Source: ./.prefab.default.config.yaml\ngoogle.gcp.project-id                              | gcp-prod                            | String  | Match: default                 | Source: ./.prefab.default.config.yaml\nlog-level                                          | debug                               | String  | Match: default                 | Source: /Users/user/.prefab.default.config.yaml\nlog-level.app                                      | info                                | String  | Match: default                 | Source: remote_cdn_api\nlog-level.app.controllers.documentation_controller | debug                               | String  | Match: default                 | Source: /Users/user/.prefab.default.config.yaml\nlog-level.google.apis.core.http_command            | info                                | String  | Match: default                 | Source: ./.prefab.default.config.yaml\nlog-level.cloud.prefab                             | debug                               | String  | Match: default                 | Source: ./.prefab.default.config.yaml\nredis.url                                          | redis://localhost:6379              | String  | Match: env:Y                   | Source: remote_cdn_api\n"})}),"\n",(0,o.jsx)(n.h2,{id:"on-initialization-failure",children:"On Initialization Failure"}),"\n",(0,o.jsxs)(n.p,{children:["Prefab goes to ",(0,o.jsx)(n.a,{href:"/docs/explanations/architecture/resiliency",children:"great lengths"})," to ensure that you can get live data, but we need to specify behavior if\nyour application cannot connect. The internal configuration store begins in a locked state. It unlocks once it has live data.\nPrefab gives you two choice if we are unable to get live data."]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"We can raise an error. This is the default."}),"\n",(0,o.jsx)(n.li,{children:"We can unlock and continue with default values."}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"Here is how to set Prefab to unlock and continue:"}),"\n",(0,o.jsxs)(t,{groupId:"lang",children:[(0,o.jsx)(i,{value:"ruby",label:"Ruby",children:(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-ruby",children:"options = Prefab::Options.new(\n  on_init_failure: Prefab::Options::ON_INITIALIZATION_FAILURE::RETURN,\n  initialization_timeout_sec: 20\n)\nPrefab.init(options)\n"})})}),(0,o.jsx)(i,{value:"java",label:"Java",children:(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:"@Singleton\npublic Prefab getClient(){\n  PrefabCloudClient prefabCloudClient = new PrefabCloudClient(\n    new Options()\n      .setInitializationTimeoutSec(20)\n      .setOnInitializationFailure(Options.OnInitializationFailure.UNLOCK)\n  );\n}\n"})})})]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}function f(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},8453:(e,n,i)=>{i.d(n,{R:()=>r,x:()=>l});var o=i(6540);const a={},t=o.createContext(a);function r(e){const n=o.useContext(t);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),o.createElement(t.Provider,{value:n},e.children)}}}]);